#!/usr/bin/env node
const help=()=>{console.log([["\n Atom Advanced Search","search, sort, and filtering tool for Atom apm packages"].join(" - "),["\n [USAGE]","apm-search [options] <name>"].join("\n   "),["\n [SELECT OPTIONS]",["  --select-packages","Get packages (default)"].join("\t"),["  --select-themes","Get themes"].join("\t"),["  --select-featured","Get featured packages/themes (ignores name argument)"].join("\t")].join("\n   "),["\n [SORT OPTIONS]",["  --sort-stars","Sort by stars (default)"].join("\t"),["  --sort-downloads","Sort by downloads"].join("\t")].join("\n   "),["\n [GENRAL OPTIONS]",["  --help       ","Show this help menu"].join("\t"),["  --verbose    ","Show more information"].join("\t"),["  --nocolor    ","Disable color printing on output"].join("\t"),["  --version    ","Output package version number"].join("\t")].join("\n   "),[""]].join("\n"))},__DEBUG__=!!process.env.NODE_DEBUG_LOGGING,debug=(...e)=>{__DEBUG__&&console.log(...e)},name="atom-advanced-search",version="1.0.1",pkgver=()=>{console.log([name,version].join(" v"))},parse_arguments=e=>{var t={};if(debug("Args:",typeof e,e),!e||0===e.length)return!1;if(!Array.isArray(e))return"object"==typeof e&&Object.entries(e).length>0&&parse_options(e),!1;var o=e.shift();do{switch(debug("start loop",o),o){case __filename:debug("found this file, skipping",o),debug("next arg",o);break;case"--help":help(),debug("help",o),process.exit(0);break;case"--version":console.log([name,version].join(" v")),debug("version",o),process.exit(0);break;case"--verbose":t.verbose=!0,debug("verbose",o);case"--sort-stars":t.sort="stars",debug("stars",o);break;case"--nocolor":process.env.NOCOLOR=!0,t.color=!1,debug("color",o);break;case"--sort-downloads":t.sort="downloads",debug("downloads",o);break;case"--select-packages":t.select="packages",debug("stars",o);break;case"--select-themes":t.select="themes",debug("themes",o);break;case"--select-featured":t.select="featured",debug("featured",o);break;default:o.match(/^--/)?(debug(`Notice: Argument '${o}' is unkown.`),debug("unknown",o)):void 0===o?debug("is undefined",o):o.length>0?(t.query=o,debug("is query",o)):debug("didnt match passing..",o),debug("----end loop----\n",o)}}while(o=e.shift());return debug("stopping",e,o),t},get_packages=(e,t)=>{console.log(["Searching apm (",t.select,") for:",e].join(" "));let o=["apm","featured"===t.select?"featured":"search","--json","themes"===t.select?"--themes":null,"featured"===t.select?null:"query"].join(" ");const{execSync:s}=require("child_process");try{const e=s(o.toString()),t=Buffer.from(e).toString("UTF-8");return JSON.parse(t.trim())}catch(e){return void console.error("exec error: ",e)}},color=e=>{var t=require("tty"),o={bold:["1m","22m"],dim:["2m","22m"],italic:["3m","23m"],underline:["4m","24m"],inverse:["7m","27m"],black:["30m","39m"],red:["31m","39m"],green:["32m","39m"],yellow:["33m","39m"],blue:["34m","39m"],magenta:["35m","39m"],cyan:["36m","39m"],white:["37m","39m"],default:["39m","39m"],grey:["90m","39m"],bgBlack:["40m","49m"],bgRed:["41m","49m"],bgGreen:["42m","49m"],bgYellow:["43m","49m"],bgBlue:["44m","49m"],bgMagenta:["45m","49m"],bgCyan:["46m","49m"],bgWhite:["47m","49m"],bgDefault:["49m","49m"]};const s=e=>["[",e].join("");return e=!process.env.NOCOLOR&&t.isatty(1)&&t.isatty(2),Object.keys(o).forEach((function(t){Object.defineProperty(String.prototype,t,{get:function(){return e?s(o[t][0])+this+s(o[t][1]):this},enumerable:!1})})),o},render=(e,t)=>{if(!e)return console.log("No packages listed"),!1;color(t.color);require("tty");var o,s,r,n,a=process.stdout.columns||80,i=(process.stdout.rows,0),c=0,d=0,l=0;const p=e=>{var t=e.metadata,o=e.stargazers_count,s=e.downloads,r=e.name;if(t){var n=e.metadata.version||e.version;e.metadata.description||e.description}parseInt(o)>i&&(i=parseInt(o)),parseInt(s)>c&&(c=parseInt(s)),r.length>d&&(d=r.length);var a=n?n.length:0;a>l&&(l=a)},g=(e,t)=>(p(e),p(t),parseInt(e.stargazers_count)<parseInt(t.stargazers_count)?1:-1),m=(e,t)=>(p(e),p(t),parseInt(e.downloads)<parseInt(t.downloads)?1:-1),u=["Stars","Downloads","Package","Description"].join(" "),b="-".padStart(u.length,"-"),f=e=>{if(!e.name)return!1;e.metadata&&(e.description=e.metadata.description,e.version=e.metadata.version);const n=e.name,i=(e.downloads||0).toString().padStart(s," "),c=(e.stargazers_count||0).toString().padStart(o," "),d=(e=>`(${e})`)(e.version||"0.0.0"),l=(e.description||"undefined").slice(0,a-r);return["downloads"===t.sort?c.default:c.yellow,"downloads"===t.sort?i.yellow:i.default,n.cyan.bold,d.dim.italic,l.default].join(" ")};n="downloads"===t.sort?e.sort(m):e.sort(g),o=i.toString().length,s=c.toString().length,r=9+o+s+d+l,(e=>{var t=[];for(var o of(t.push(u.bold),t.push(b),e))t.push(f(o));console.log(t.join("\n"))})(n)},__DEV__="dev"===process.env.NODE_ENV||"development"===process.env.NODE_ENV,encoding="utf-8";var query,data="";const defaults={verbose:!1,sort:"stars",select:"packages",color:!0},main=(e,t)=>{e||t.select||(help(),process.exit(0)),t.verbose&&console.log("options",t);const o=get_packages(e,t);render(o,t)},parse_options$1=()=>{var e=process.env.PKG_OPTIONS||"{}";return options=Object.assign({},defaults,JSON.parse(e)),debug("Process Env:",process.env,"Options: ",options),options},process_stream=e=>{const t=Buffer.from(data).toString("utf-8");t||(help(),process.exit(0));try{var o=JSON.parse(t.trim());debug(o)}catch(e){console.log("Error processing input data",e)}finally{render(o,e)}};var options;options=parse_options$1();var args=process.argv;args.shift(),args[0]===__filename&&args.shift();var runtime_options=parse_arguments(args);query=(options=Object.assign({},options,runtime_options)).query,process.stdin.isTTY?main(query,options):process.stdin.setEncoding("utf-8").on("readable",(function(){for(var e;e=process.stdin.read();)data+=e})).on("end",(function(){data=data.replace(/\n$/,""),process_stream(options)}));
