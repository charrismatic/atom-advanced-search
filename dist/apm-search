#!/usr/bin/env node
const help=()=>{console.log([["\n Atom Advanced Search","search, sort, and filtering tool for Atom apm packages"].join(" - "),["\n [USAGE]","apm-search [options] <name>"].join("\n   "),["\n [SELECT OPTIONS]",["  --select-packages","Get packages (default)"].join("\t"),["  --select-themes","Get themes"].join("\t"),["  --select-featured","Get featured packages/themes (ignores name argument)"].join("\t")].join("\n   "),["\n [SORT OPTIONS]",["  --sort-stars","Sort by stars (default)"].join("\t"),["  --sort-downloads","Sort by downloads"].join("\t")].join("\n   "),["\n [GENRAL OPTIONS]",["  --help       ","Show this help menu"].join("\t"),["  --verbose    ","Show more information"].join("\t"),["  --nocolor    ","Disable color printing on output"].join("\t"),["  --version    ","Output package version number"].join("\t")].join("\n   "),[""]].join("\n"))},__DEBUG__=!!process.env.NODE_DEBUG_LOGGING,debug=(...e)=>{__DEBUG__&&console.log(...e)},name="atom-advanced-search",version="1.0.0",pkgver=()=>{console.log([name,version].join(" v"))},parse_arguments=e=>{var s={};if(debug("Args:",typeof e,e),!e)return!1;if(!Array.isArray(e))return"object"==typeof e&&Object.entries(e).length>0&&parse_options(e),!1;var t=e.shift();do{switch(debug("start loop",t),t){case __filename:debug("found this file, skipping",t),debug("next arg",t);break;case"--help":help(),debug("help",t),process.exit(0);break;case"--version":console.log([name,version].join(" v")),debug("version",t),process.exit(0);break;case"--verbose":s.verbose=!0,debug("verbose",t);case"--sort-stars":s.sort="stars",debug("stars",t);break;case"--nocolor":process.env.NOCOLOR=!0,s.color=!1,debug("color",t);break;case"--sort-downloads":s.sort="downloads",debug("downloads",t);break;case"--select-packages":s.select="packages",debug("stars",t);break;case"--select-themes":s.select="themes",debug("themes",t);break;case"--select-featured":s.select="featured",debug("featured",t);break;default:t.match(/^--/)?(debug(`Notice: Argument '${t}' is unkown.`),debug("unknown",t)):void 0===t?debug("is undefined",t):t.length>0?(s.query=t,debug("is query",t)):debug("didnt match passing..",t),debug("----end loop----\n",t)}}while(t=e.shift());return debug("stopping",e,t),s},get_packages=(e,s)=>{let t=["apm","featured"===s.select?"featured":"search","--json","themes"===s.select?"--themes":"","featured"===s.select?"":e].join(" ");console.log(`Searching apm (${s.select}) for:`,e);const{execSync:o}=require("child_process");try{const e=o(`${t}`),s=Buffer.from(e).toString("UTF-8");return JSON.parse(s.trim())}catch(e){return void console.error(`exec error: ${e}`)}},color=e=>{var s=require("tty"),t={bold:["1m","22m"],dim:["2m","22m"],italic:["3m","23m"],underline:["4m","24m"],inverse:["7m","27m"],black:["30m","39m"],red:["31m","39m"],green:["32m","39m"],yellow:["33m","39m"],blue:["34m","39m"],magenta:["35m","39m"],cyan:["36m","39m"],white:["37m","39m"],default:["39m","39m"],grey:["90m","39m"],bgBlack:["40m","49m"],bgRed:["41m","49m"],bgGreen:["42m","49m"],bgYellow:["43m","49m"],bgBlue:["44m","49m"],bgMagenta:["45m","49m"],bgCyan:["46m","49m"],bgWhite:["47m","49m"],bgDefault:["49m","49m"]};const o=e=>`[${e}`;return e=!process.env.NOCOLOR&&s.isatty(1)&&s.isatty(2),Object.keys(t).forEach((function(s){Object.defineProperty(String.prototype,s,{get:function(){return e?o(t[s][0])+this+o(t[s][1]):this},enumerable:!1})})),t},render=(e,s)=>{color(s.color);require("tty");var t,o,r,n,a=process.stdout.columns||80,i=(process.stdout.rows,0),c=0,d=0,l=0;const m=e=>{e.metadata&&(e.description=e.metadata.description,e.version=e.metadata.version),parseInt(e.stargazers_count)>i&&(i=parseInt(e.stargazers_count)),parseInt(e.downloads)>c&&(c=parseInt(e.downloads)),e.name.length>d&&(d=e.name.length);var s=e.version?e.version.length:0;s>l&&(l=s)},p=(e,s)=>(m(e),m(s),parseInt(e.stargazers_count)<parseInt(s.stargazers_count)?1:-1),g=(e,s)=>(m(e),m(s),parseInt(e.downloads)<parseInt(s.downloads)?1:-1),u=["Stars","Downloads","Package","Description"].join(" "),b="-".padStart(u.length,"-"),f=e=>{if(!e.name)return!1;e.metadata&&(e.description=e.metadata.description,e.version=e.metadata.version);const n=e.name,i=(e.downloads||0).toString().padStart(o," "),c=(e.stargazers_count||0).toString().padStart(t," "),d=(e=>`(${e})`)(e.version||"0.0.0"),l=(e.description||"undefined").slice(0,a-r);return["downloads"===s.sort?c.default:c.yellow,"downloads"===s.sort?i.yellow:i.default,n.cyan.bold,d.dim.italic,l.default].join(" ")};n="downloads"===s.sort?e.sort(g):e.sort(p),t=i.toString().length,o=c.toString().length,r=8+t+o+d+l,(e=>{var s=[];for(var t of(s.push(u.bold),s.push(b),e))s.push(f(t));console.log(s.join("\n"))})(n)},__DEV__="dev"===process.env.NODE_ENV||"development"===process.env.NODE_ENV,encoding="utf-8",defaults={verbose:!1,sort:"stars",select:"packages",color:!0};var options,query,data="";const main=(e,s)=>{e||(help(),process.exit(0)),s.verbose&&console.log("options",s),debug("parsed",s,e);const t=get_packages(e,s);render(t,s)},parse_options$1=()=>{var e=process.env.PKG_OPTIONS||"{}";return options=Object.assign({},defaults,JSON.parse(e)),debug("Process Env:",process.env,"Options: ",options),options},process_stream=()=>{const e=Buffer.from(data).toString("utf-8");var s=JSON.parse(e.trim());debug(s),render(s,options)};options=parse_options$1();var args=process.argv;args.shift(),args[0]===__filename&&args.shift(),args&&0!==args.length||(help(),process.exit(0));var runtime_options=parse_arguments(args);query=(options=Object.assign({},options,runtime_options)).query,process.stdin.isTTY?main(query,options):process.stdin.setEncoding("utf-8").on("readable",(function(){for(var e;e=process.stdin.read();)data+=e})).on("end",(function(){data=data.replace(/\n$/,""),process_stream()}));
